name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.11"

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --dev

      - name: Run ruff check
        run: uv run ruff check src/ tests/

      - name: Run ruff format check
        run: uv run ruff format --check src/ tests/

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --dev

      - name: Run ty check
        run: uv run ty check

  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12", "3.13"]

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --dev

      - name: Run tests
        run: |
          uv run pytest tests/ -v --tb=short -x \
            --ignore=tests/test_signal/test_correctness_vs_alphalens.py \
            --ignore=tests/validation \
            -k "not (TestSHAP or test_shap or TestKernelExplainer or test_save_png or test_setup_complete)" \
            --deselect tests/test_core/test_purging.py::TestPurgingValidation::test_purge_timestamps_require_tz_awareness \
            --deselect tests/test_core/test_purging.py::TestPurgingValidation::test_purge_test_start_requires_tz_awareness \
            --deselect tests/test_core/test_purging.py::TestPurgingValidation::test_purge_test_end_requires_tz_awareness \
            --deselect tests/test_core/test_purging.py::TestEmbargoValidation::test_embargo_timestamps_require_tz_awareness \
            --deselect tests/test_core/test_purging.py::TestEmbargoValidation::test_embargo_test_start_requires_tz_awareness \
            --deselect tests/test_core/test_purging.py::TestEmbargoValidation::test_embargo_test_end_requires_tz_awareness \
            --deselect tests/test_core/test_purging_correctness.py::TestTimestampBasedPurging::test_timezone_awareness_required \
            --deselect tests/test_evaluation/test_metrics.py::TestExplainerCreationPaths \
            --deselect tests/test_evaluation/test_metrics.py::TestGPUExplainerPaths \
            --deselect tests/test_evaluation/test_metrics.py::TestExplainerFallbackCascade \
            --deselect tests/test_evaluation/test_metrics.py::TestDeepExplainerPaths \
            --deselect tests/test_evaluation/test_metrics.py::TestUnknownExplainerType \
            --deselect tests/test_evaluation/test_metrics.py::TestAutoExplainerFallbackCascade \
            --deselect tests/test_evaluation/test_metrics.py::TestExplainerWithBinaryClassifier \
            --deselect tests/test_evaluation/test_metrics.py::TestAnalyzeInteractionsMorePaths::test_analyze_interactions_with_shap \
            --deselect tests/test_evaluation/test_metrics.py::TestAnalyzeInteractionsMethodFailures::test_interactions_shap_with_pairs_filter \
            --deselect tests/test_visualization/test_cv_plots.py::TestPlotCvFoldsColors::test_train_bar_color \
            --deselect tests/test_evaluation/test_multi_signal_performance.py::TestParallelPerformance::test_parallel_faster_than_sequential

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --dev

      - name: Run tests with coverage
        run: |
          uv run pytest tests/ \
            --cov=ml4t.diagnostic --cov-report=xml --cov-report=term-missing \
            --ignore=tests/test_signal/test_correctness_vs_alphalens.py \
            --ignore=tests/validation \
            -k "not (TestSHAP or test_shap or TestKernelExplainer or test_save_png or test_setup_complete)" \
            --deselect tests/test_core/test_purging.py::TestPurgingValidation::test_purge_timestamps_require_tz_awareness \
            --deselect tests/test_core/test_purging.py::TestPurgingValidation::test_purge_test_start_requires_tz_awareness \
            --deselect tests/test_core/test_purging.py::TestPurgingValidation::test_purge_test_end_requires_tz_awareness \
            --deselect tests/test_core/test_purging.py::TestEmbargoValidation::test_embargo_timestamps_require_tz_awareness \
            --deselect tests/test_core/test_purging.py::TestEmbargoValidation::test_embargo_test_start_requires_tz_awareness \
            --deselect tests/test_core/test_purging.py::TestEmbargoValidation::test_embargo_test_end_requires_tz_awareness \
            --deselect tests/test_core/test_purging_correctness.py::TestTimestampBasedPurging::test_timezone_awareness_required \
            --deselect tests/test_evaluation/test_metrics.py::TestExplainerCreationPaths \
            --deselect tests/test_evaluation/test_metrics.py::TestGPUExplainerPaths \
            --deselect tests/test_evaluation/test_metrics.py::TestExplainerFallbackCascade \
            --deselect tests/test_evaluation/test_metrics.py::TestDeepExplainerPaths \
            --deselect tests/test_evaluation/test_metrics.py::TestUnknownExplainerType \
            --deselect tests/test_evaluation/test_metrics.py::TestAutoExplainerFallbackCascade \
            --deselect tests/test_evaluation/test_metrics.py::TestExplainerWithBinaryClassifier \
            --deselect tests/test_evaluation/test_metrics.py::TestAnalyzeInteractionsMorePaths::test_analyze_interactions_with_shap \
            --deselect tests/test_evaluation/test_metrics.py::TestAnalyzeInteractionsMethodFailures::test_interactions_shap_with_pairs_filter

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true

  property-tests:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --dev

      - name: Run property-based tests
        run: uv run pytest tests/test_property/ -v --hypothesis-seed=42 --hypothesis-profile=ci

  benchmarks:
    name: Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --dev

      - name: Run benchmarks
        run: uv run pytest tests/test_benchmarks/ -p no:xdist -o "addopts=" --benchmark-only --benchmark-autosave

  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Build package
        run: uv build

      - name: Check package metadata
        run: |
          uv run python -c "import ml4t.diagnostic; print(f'Version: {ml4t.diagnostic.__version__}')"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
